<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alma – Demo (chat + vídeo D-ID)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px; }
    .row { display: grid; grid-template-columns: 1fr 520px; gap: 24px; align-items: start; }
    .ask { display: flex; gap: 8px; margin-bottom: 12px; }
    .ask input { flex: 1; padding: 10px 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
    .ask button { padding: 10px 14px; font-size: 16px; border: 0; background: #2d6cdf; color: #fff; border-radius: 8px; cursor: pointer; }
    .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 12px; background: #fafafa; }
    .err { color: #c62828; margin: 8px 0; }
    .answer { white-space: pre-wrap; line-height: 1.4; }
    video { width: 100%; border-radius: 12px; background: #000; }
    figure { margin: 0; }
    figcaption { margin-top: 6px; font-size: 12px; color: #666; }
    details { margin-top: 20px; }
    pre { background: #111; color: #8bd; padding: 12px; border-radius: 8px; overflow: auto; }
    .muted { color: #666; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Alma</h1>

  <div class="ask">
    <input id="q" type="text" placeholder="Escreve aqui…" value="olá" />
    <button id="go">Perguntar</button>
  </div>

  <div class="row">
    <div class="card">
      <div id="err" class="err" hidden></div>
      <div class="answer" id="txt">—</div>
      <p class="muted">Se o vídeo não arrancar automaticamente no iOS, toca no vídeo para iniciar.</p>
    </div>

    <figure>
      <video id="vid" controls playsinline preload="none"></video>
      <figcaption>Vídeo gerado pelo D-ID a partir do texto da Alma.</figcaption>
    </figure>
  </div>

  <details>
    <summary>Diagnóstico</summary>
    <pre id="diag">—</pre>
  </details>

<script>
  // =======================
  // CONFIGURAÇÃO
  // =======================
  const API_BASE = 'https://alma-server-alma-1.up.railway.app'; // <- muda se o teu domínio for outro

  // =======================
  // HELPERS
  // =======================
  const $ = sel => document.querySelector(sel);
  const setError = (msg) => {
    const el = $('#err');
    if (!msg) { el.hidden = true; el.textContent = ''; return; }
    el.hidden = false; el.textContent = 'Erro: ' + msg;
  };
  const setDiag = (obj, label='raw') => {
    const pre = $('#diag');
    const content = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
    pre.textContent = `# ${label}\n${content}`;
  };

  // =======================
  // CHAMADAS
  // =======================
  async function askNLP(question) {
    // POST /ask (Grok) -> { answer }
    const r = await fetch(`${API_BASE}/ask`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ question })
    });
    const body = await r.text(); // para diagnosticar facilmente
    setDiag({ status: r.status, body }, 'NLP raw');
    if (!r.ok) throw new Error(`/ask ${r.status}`);
    const j = JSON.parse(body);
    return j.answer || '';
  }

  async function sayVideo(text) {
    // POST /say (D-ID) -> { video_url }
    const r = await fetch(`${API_BASE}/say`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ text })
    });
    const body = await r.text();
    setDiag({ status: r.status, body }, 'say raw');
    if (!r.ok) throw new Error(`(say) ${r.status}`);
    const j = JSON.parse(body);
    if (!j.video_url) throw new Error('Resposta sem video_url');
    return j.video_url;
  }

  // =======================
  // UI
  // =======================
  async function run() {
    setError('');
    $('#txt').textContent = '… a pensar';
    const q = $('#q').value.trim();
    if (!q) { setError('Escreve uma mensagem'); return; }

    try {
      // 1) pergunta ao Grok
      const answer = await askNLP(q);
      $('#txt').textContent = answer || 'Sem resposta do Grok.';

      // 2) pede o vídeo ao /say (D-ID)
      const url = await sayVideo(answer || q); // se vier vazio, usa a pergunta
      const v = $('#vid');
      v.src = url;
      // alguns browsers só tocam após user gesture
      try { await v.play(); } catch (_) { /* o utilizador toca manualmente */ }
    } catch (e) {
      console.error(e);
      setError(e.message || 'Load failed');
    }
  }

  $('#go').addEventListener('click', run);
  $('#q').addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') run();
  });
</script>
</body>
</html>
