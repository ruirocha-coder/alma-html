<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alma</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    h1 { margin: 0 0 12px; }
    .bar { display:flex; gap:10px; margin-bottom:12px; }
    input { flex:1; padding:10px 12px; border:1px solid #ccc; border-radius:8px; font-size:16px; }
    button { padding:10px 14px; border:0; border-radius:8px; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    #answer { background:#fafafa; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:10px; min-height:44px; }
    #error { color:#b91c1c; font-weight:600; margin-bottom:8px; display:none; }
    video { width:100%; max-width:520px; background:#000; border-radius:10px; border:1px solid #eee; }
    details { margin-top:14px; }
    pre { background:#111; color:#0f0; padding:10px; border-radius:8px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>Alma</h1>

  <div class="bar">
    <input id="q" placeholder="Escreve aqui a tua pergunta…" />
    <button id="askBtn">Perguntar</button>
  </div>

  <div id="error"></div>
  <div id="answer"></div>
  <video id="video" playsinline controls preload="none"></video>

  <details>
    <summary>Diagnóstico</summary>
    <pre id="dbg">—</pre>
  </details>

<script>
  // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  // TROCAR APENAS ESTES 2 ENDPOINTS PELOS TEUS:
  const NLP_API     = "https://alma-server-alma-1.up.railway.app/ask";   // <-- /ask do teu alma-server
  const DID_BACKEND = "https://almabody-alma-1.up.railway.app";          // <-- base do almabody (tem /say)
  // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

  const $q = document.getElementById('q');
  const $btn = document.getElementById('askBtn');
  const $ans = document.getElementById('answer');
  const $err = document.getElementById('error');
  const $vid = document.getElementById('video');
  const $dbg = document.getElementById('dbg');

  function setErr(msg){ $err.style.display='block'; $err.textContent="Erro: "+msg; }
  function clrErr(){ $err.style.display='none'; $err.textContent=""; }
  function dbg(title, payload){
    let t = title+"\n";
    try { t += (typeof payload === 'string') ? payload : JSON.stringify(payload,null,2); }
    catch(e){ t += String(e); }
    $dbg.textContent = t;
  }

  async function ask(){
    clrErr();
    $btn.disabled = true;
    $ans.textContent = "";
    $vid.src = "";

    const question = ($q.value || "").trim();
    if(!question){ setErr("Pergunta vazia."); $btn.disabled=false; return; }

    // 1) Pergunta ao NLP
    let answer;
    try{
      const r = await fetch(NLP_API, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ question })
      });
      const txt = await r.text();
      dbg("# /ask raw", {status:r.status, body:txt});
      const j = JSON.parse(txt);
      if(!r.ok) throw new Error(j?.answer || r.statusText);
      answer = j?.answer || "Sem resposta.";
      $ans.textContent = answer;
    }catch(e){
      setErr(e?.message || "Falha no /ask");
      $btn.disabled = false;
      return;
    }

    // 2) Pede vídeo ao D-ID através do almabody (/say)
    try{
      const r2 = await fetch(DID_BACKEND + "/say", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text: answer })
      });
      const txt2 = await r2.text();
      dbg("# /say raw", {status:r2.status, body:txt2});

      const j2 = JSON.parse(txt2);
      if(!r2.ok) throw new Error(j2?.error || r2.statusText);
      if(!j2?.video_url) throw new Error("Resposta sem video_url");

      $vid.src = j2.video_url;
      $vid.play().catch(()=>{/* iOS precisa de toque */});
    }catch(e){
      setErr(e?.message || "Falha no /say");
    }finally{
      $btn.disabled = false;
    }
  }

  document.getElementById('askBtn').addEventListener('click', ask);
  document.getElementById('q').addEventListener('keydown', e => { if(e.key==="Enter") ask(); });
</script>
</body>
</html>
